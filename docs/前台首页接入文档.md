# 前台系统API接入文档 - 首页推荐系统

## 📖 概述

本文档描述了前台系统接入首页推荐系统的API接口，包括公开接口和个性化推荐接口。系统提供两套推荐方案：

- **公开推荐**：面向所有用户的通用推荐（无需登录）
- **个性化推荐**：基于用户行为的精准推荐（需要登录）

## 🌐 接口域名

```
BASE_URL: http://localhost:3000
```

## 🔐 认证说明

### 公开接口

- 无需认证，直接调用

### 个性化推荐接口

- 需要JWT Token认证
- Header中添加：`Authorization: Bearer {token}`

---

## 📱 一、公开推荐接口（无需登录）

### 1.1 获取完整首页数据

**接口地址：** `GET /public/homepage/data`

**描述：** 一次性获取首页所需的全部数据，包括轮播图和各类推荐内容

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | number | 否 | 用户ID，传入后可获得个性化内容 |

**请求示例：**

```javascript
// 获取通用首页数据
fetch('/public/homepage/data');

// 获取带个性化的首页数据（已登录用户）
fetch('/public/homepage/data?userId=123');
```

**响应示例：**

```json
{
  "code": 200,
  "message": "获取首页数据成功",
  "data": {
    "banners": [
      {
        "id": 1,
        "title": "春季新品发布",
        "imageUrl": "https://example.com/banner1.jpg",
        "linkUrl": "/products/spring-2024",
        "sortOrder": 1
      }
    ],
    "recommendations": {
      "hotBooths": [
        {
          "id": "123",
          "boothName": "美食档口",
          "description": "精选美食",
          "imageUrl": "https://example.com/booth123.jpg",
          "score": 95.5
        }
      ],
      "latestBooths": [],
      "hotProducts": [],
      "latestProducts": [],
      "personalizedBooths": [], // 仅在传入userId时包含
      "personalizedProducts": [] // 仅在传入userId时包含
    },
    "metadata": {
      "hasPersonalization": false,
      "userType": "guest",
      "generatedAt": "2024-01-01T12:00:00Z"
    },
    "timestamp": "2024-01-01T12:00:00Z",
    "fromCache": true
  }
}
```

### 1.2 获取档口推荐

**接口地址：** `GET /public/homepage/booth-recommendations`

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| type | string | 否 | 推荐类型：`booth_hot`(热门) / `booth_new`(最新) |
| limit | number | 否 | 数量限制，默认8 |
| userId | number | 否 | 用户ID |

**请求示例：**

```javascript
// 获取热门档口
fetch('/public/homepage/booth-recommendations?type=booth_hot&limit=8');

// 获取最新档口
fetch('/public/homepage/booth-recommendations?type=booth_new&limit=6');
```

### 1.3 获取商品推荐

**接口地址：** `GET /public/homepage/product-recommendations`

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| type | string | 否 | 推荐类型：`product_hot`(热门) / `product_new`(最新) |
| limit | number | 否 | 数量限制，默认12 |
| userId | number | 否 | 用户ID |

### 1.4 获取轮播图

**接口地址：** `GET /public/homepage/banners`

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| limit | number | 否 | 数量限制，默认5 |

---

## 👤 二、个性化推荐接口（需要登录）

> **重要：** 所有个性化推荐接口都需要在Header中携带JWT Token

### 2.1 个性化档口推荐

**接口地址：** `GET /api/recommendations/personalized/booths`

**认证：** 需要JWT Token

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| limit | number | 否 | 推荐数量，默认10 |
| days | number | 否 | 分析最近几天的行为数据，默认30天 |

**请求示例：**

```javascript
fetch('/api/recommendations/personalized/booths?limit=8&days=30', {
  headers: {
    Authorization: `Bearer ${token}`,
    'Content-Type': 'application/json',
  },
});
```

**响应示例：**

```json
{
  "success": true,
  "data": {
    "recommendations": [
      {
        "id": "123",
        "score": 95.5,
        "reason": "基于您的访问历史",
        "type": "booth"
      }
    ],
    "userId": 123,
    "total": 8,
    "algorithm": "personalized"
  }
}
```

### 2.2 个性化商品推荐

**接口地址：** `GET /api/recommendations/personalized/products`

**参数和响应格式同档口推荐**

### 2.3 协同过滤推荐

**接口地址：**

- `GET /api/recommendations/similar-users/booths` - 相似用户的档口推荐
- `GET /api/recommendations/similar-users/products` - 相似用户的商品推荐

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| limit | number | 否 | 推荐数量，默认10 |

### 2.4 趋势推荐

**接口地址：**

- `GET /api/recommendations/trending/booths` - 趋势档口推荐
- `GET /api/recommendations/trending/products` - 趋势商品推荐

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| limit | number | 否 | 推荐数量，默认10 |

### 2.5 混合推荐（推荐使用）

**接口地址：** `GET /api/recommendations/mixed`

**描述：** 融合个性化、协同过滤、趋势三种算法的综合推荐

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| targetType | string | 是 | 推荐类型：`booth` 或 `product` |
| limit | number | 否 | 推荐数量，默认15 |

**响应示例：**

```json
{
  "success": true,
  "data": {
    "recommendations": [
      {
        "id": "123",
        "score": 98.5,
        "reason": "基于您的访问历史",
        "type": "booth",
        "algorithm": "personalized"
      }
    ],
    "userId": 123,
    "total": 15,
    "algorithm": "mixed",
    "breakdown": {
      "personalized": 5,
      "trending": 4,
      "collaborative": 6,
      "final": 15
    }
  }
}
```

---

## 📊 三、用户行为记录接口

### 3.1 记录用户行为

**接口地址：** `POST /api/behavior/record`

**描述：** 记录用户的浏览、点击、收藏等行为，用于优化推荐算法

**请求参数：**

```json
{
  "userId": 123,
  "behaviorType": "view", // view/click/favorite/share
  "targetType": "booth", // booth/product
  "targetId": "booth_123",
  "sessionId": "optional_session_id",
  "metadata": {
    "source": "homepage", // 来源页面
    "position": 1, // 在推荐列表中的位置
    "algorithm": "personalized" // 推荐算法类型
  }
}
```

### 3.2 获取热门内容

**接口地址：** `GET /api/behavior/popular/{targetType}`

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| targetType | string | 是 | 内容类型：`booth` 或 `product` |
| days | number | 否 | 统计天数，默认7天 |
| limit | number | 否 | 返回数量，默认10 |

---

## 🎨 四、前端集成示例

### 4.1 首页组件集成

```javascript
// React示例
import React, { useEffect, useState } from 'react';

const Homepage = () => {
  const [homepageData, setHomepageData] = useState(null);
  const [personalizedRecommendations, setPersonalizedRecommendations] =
    useState(null);

  useEffect(() => {
    // 加载公开首页数据
    loadHomepageData();

    // 如果用户已登录，加载个性化推荐
    if (isLoggedIn()) {
      loadPersonalizedRecommendations();
    }
  }, []);

  const loadHomepageData = async () => {
    try {
      const userId = getCurrentUserId(); // 获取当前用户ID（如果已登录）
      const url = userId
        ? `/public/homepage/data?userId=${userId}`
        : '/public/homepage/data';

      const response = await fetch(url);
      const data = await response.json();
      setHomepageData(data.data);
    } catch (error) {
      console.error('加载首页数据失败:', error);
    }
  };

  const loadPersonalizedRecommendations = async () => {
    try {
      const token = getAuthToken();
      const response = await fetch(
        '/api/recommendations/mixed?targetType=product&limit=12',
        {
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        },
      );
      const data = await response.json();
      setPersonalizedRecommendations(data.data);
    } catch (error) {
      console.error('加载个性化推荐失败:', error);
    }
  };

  // 记录用户行为
  const recordBehavior = async (
    behaviorType,
    targetType,
    targetId,
    metadata = {},
  ) => {
    try {
      const userId = getCurrentUserId();
      await fetch('/api/behavior/record', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId,
          behaviorType,
          targetType,
          targetId,
          metadata: {
            source: 'homepage',
            ...metadata,
          },
        }),
      });
    } catch (error) {
      console.error('记录行为失败:', error);
    }
  };

  return (
    <div className="homepage">
      {/* 轮播图区域 */}
      {homepageData?.banners && (
        <BannerSection
          banners={homepageData.banners}
          onBannerClick={(banner) =>
            recordBehavior('click', 'banner', banner.id)
          }
        />
      )}

      {/* 热门档口推荐 */}
      {homepageData?.recommendations?.hotBooths && (
        <RecommendationSection
          title="热门档口"
          items={homepageData.recommendations.hotBooths}
          onItemClick={(booth, index) =>
            recordBehavior('click', 'booth', booth.id, {
              position: index,
              algorithm: 'hot',
            })
          }
        />
      )}

      {/* 个性化推荐（仅登录用户） */}
      {personalizedRecommendations && (
        <RecommendationSection
          title="为您推荐"
          items={personalizedRecommendations.recommendations}
          onItemClick={(item, index) =>
            recordBehavior('click', item.type, item.id, {
              position: index,
              algorithm: item.algorithm,
            })
          }
        />
      )}
    </div>
  );
};
```

### 4.2 搜索页面集成

```javascript
const SearchPage = () => {
  const [searchResults, setSearchResults] = useState([]);
  const [recommendations, setRecommendations] = useState([]);

  // 在搜索结果旁显示推荐
  const loadSearchRecommendations = async (searchType) => {
    try {
      const token = getAuthToken();
      if (token) {
        // 已登录用户：个性化推荐
        const response = await fetch(
          `/api/recommendations/personalized/${searchType}s?limit=6`,
          {
            headers: { Authorization: `Bearer ${token}` },
          },
        );
        const data = await response.json();
        setRecommendations(data.data.recommendations);
      } else {
        // 未登录用户：趋势推荐
        const response = await fetch(
          `/api/recommendations/trending/${searchType}s?limit=6`,
        );
        const data = await response.json();
        setRecommendations(data.data.recommendations);
      }
    } catch (error) {
      console.error('加载搜索推荐失败:', error);
    }
  };

  return (
    <div className="search-page">
      <div className="search-results">{/* 搜索结果 */}</div>
      <div className="recommendations">
        <h3>相关推荐</h3>
        {recommendations.map((item, index) => (
          <RecommendationItem
            key={item.id}
            item={item}
            onClick={() =>
              recordBehavior('click', item.type, item.id, {
                source: 'search_recommendations',
                position: index,
              })
            }
          />
        ))}
      </div>
    </div>
  );
};
```

---

## ⚠️ 注意事项

### 1. 错误处理

- 所有接口都应该有适当的错误处理
- 网络错误时显示默认推荐内容
- 个性化推荐失败时降级到通用推荐

### 2. 性能优化

- 使用缓存避免重复请求
- 实现骨架屏提升用户体验
- 懒加载非关键推荐内容

### 3. 用户体验

- 记录用户行为时不影响页面性能
- 提供推荐理由提升用户信任度
- 支持推荐内容的刷新功能

### 4. 数据埋点

建议在关键位置添加数据埋点：

```javascript
// 推荐内容曝光
recordBehavior('view', 'product', productId, {
  source: 'homepage_personalized',
  position: index,
  algorithm: 'mixed',
});

// 推荐内容点击
recordBehavior('click', 'product', productId, {
  source: 'homepage_personalized',
  position: index,
  algorithm: 'personalized',
});

// 推荐内容收藏
recordBehavior('favorite', 'product', productId, {
  source: 'homepage_personalized',
});
```

---

## 📞 技术支持

如有问题，请联系后端开发团队或查看详细的Swagger API文档。
